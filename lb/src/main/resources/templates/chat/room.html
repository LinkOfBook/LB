<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<script th:src="@{/js/jquery-3.6.0.js}"></script>
<!--<script th:inline="javascript" th:src="@{/js/basic.js}"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.2/sockjs.js"></script>
<!--<script th:src="@{/js/bootstrap.bundle.min.js}"></script>-->

<th:block th:replace="~{/layout/main :: setContent(~{this :: content})}">

	<link th:href="@{/css/simple-sidebar.css}" rel="stylesheet">
	<div th:fragment="content">

		<div class="container-fluid bg-light py-3 mb-5 hero-header"></div>

		<div class="d-flex" id="wrapper">

			<!-- Sidebar -->
			<th:block th:if="${#authentication.principal.username eq room.buno}">
				<div class="bg-light border-right" id="sidebar-wrapper">
					<div class="sidebar-heading" style="text-align: center;">채팅목록</div>
					<div class="list-group list-group-flush" id="list"></div>
				</div>
			</th:block>
			<!-- /#sidebar-wrapper -->

			<div class="container-fluid">
				<div class="container">
					<div class="col-6">
						<h1>채팅하기</h1>
					</div>
					<div id="beforeArea" class="col" th:each="chatMessage : ${chatMessage}"
						style="margin-bottom: 10px;">
					</div>

					<div id="msgArea" class="col"></div>
					<div class="col-6">
						<div class="input-group mb-3" id="search">
							<input type="text" id="msg" class="form-control">
							<div class="input-group-append">
								<button class="btn btn-outline-secondary" type="button" id="button-send">전송</button>
							</div>
						</div>
					</div>
				</div>
				<div class="col-6"></div>
			</div>
		</div>




		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		<script th:inline="javascript">
			$(document).ready(function () {

				var chatMessage = /*[[${chatMessage}]]*/[];

				console.log(chatMessage);
				var roomId = /*[[${room.roomId}]]*/ '';
				var buno = /*[[${room.buno}]]*/ '';
				var username = /*[[${#authentication.principal.username}]]*/ '';
				var name = /*[[${room.name}]]*/ '';

				console.log(roomId + ", " + username);

				var sockJs = new SockJS("/lb/stomp/chat");
				//1. SockJS를 내부에 들고있는 stomp를 내어줌
				var stomp = Stomp.over(sockJs);

				//2. connection이 맺어지면 실행
				stomp.connect({}, function () {
					console.log("STOMP Connection");

					if (chatMessage) {
						chatMessage.forEach(function (chat) {
							var writer = chat.writer; // Corrected variable name
							var message = chat.message; // Corrected variable name
							var created_day = chat.created_day;
							// created_day를 JavaScript Date 객체로 변환
							var date = new Date(created_day);

							// 시간을 "시:분" 형식으로 포맷
							var formattedTime = date.getHours() + ':' + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
							var str = '';

							if (writer === username) {
								str = "<div class='col-6'>";
								str += "<div class='alert alert-secondary'>";
								str += "<b>" + writer + " : " + message + "         시간 ->" + formattedTime + "</b>";
								str += "</div></div>";
							} else {
								str = "<div class='col-6'>";
								str += "<div class='alert alert-warning'>";
								str += "<b>" + writer + " : " + message + "         시간 ->" + formattedTime + "</b>";
								str += "</div></div>";
							}

							$("#beforeArea").append(str);

						});

						var str2 = '';

						var writer = username;

						str2 = "<div class='col-6'>";
						str2 += "<div class='alert alert-secondary'>";
						str2 += "<b>" + writer + "님이 채팅방에 참여했습니다." + "</b>";
						str2 += "</div></div>";

						$("#msgArea").append(str2);
						
						document.getElementById("msg").focus();

					}


					//4. subscribe(path, callback)으로 메세지를 받을 수 있음
					stomp.subscribe("/sub/chat/room/" + roomId, function (chat, chatmessage) {
						var content = JSON.parse(chat.body);
						console.log("이름", name);
						console.log(content);
						console.log(content.writer)

						var writer = content.writer;
						var realwriter = name;
						var message = content.message; // Define 'message' here
						let today = new Date();

						var formattedTime = today.getHours() + ':' + (today.getMinutes() < 10 ? '0' : '') + today.getMinutes();

						var str = '';

						if (writer === username) {
							str = "<div class='col-6'>";
							str += "<div class='alert alert-secondary'>";
							str += "<b>" + writer + " : " + message + "   시간 -> " + formattedTime + "</b>";
							str += "</div></div>";
						}
						else {
							str = "<div class='col-6'>";
							str += "<div class='alert alert-warning'>";
							str += "<b>" + writer + " : " + message + "   시간 -> " + formattedTime + "</b>";
							str += "</div></div>";
						}

						$("#msgArea").append(str);
					});

					//3. send(path, header, message)로 메세지를 보낼 수 있음
					stomp.send('/pub/chat/enter', {}, JSON.stringify({roomId: roomId, writer: username}))
				});

				$("#button-send").on("click", function (e) {
					var msg = document.getElementById("msg");

					console.log(username + ":" + msg.value);
					stomp.send('/pub/chat/message', {}, JSON.stringify({roomId: roomId, message: msg.value, writer: username}));
					msg.value = '';
				});
			});
		</script>

		<script th:inline="javascript">

			var roomList = /*[[${roomList}]]*/[];

			console.log("roomList :", roomList);

			var str = '';
			if (roomList) {
				roomList.forEach(function (room) {
					str += '<div>';
					str += '<form action="../chat/BoardchatRoom" method="post">';
					str += '<input type="hidden" name="bbno" value=' + room.bbno + '>';
					str += '<input type="hidden" name="roomId" value=' + room.roomId + '>';
					str += '<input type="submit" class="list-group-item list-group-item-action bg-light" value="' + room.id + '님과 채팅하기"></input>';
					str += '</form>';
					str += '</div>';
				});
			}



			$("#menu-toggle").click(function (e) {
				e.preventDefault();
				$("#wrapper").toggleClass("toggled");
			});
			$("#list").append(str);
		</script>


</th:block>
</th:block>

</html>